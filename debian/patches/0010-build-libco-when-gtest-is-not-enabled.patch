From: Andrei Pavel <andrei@isc.org>
Subject: [PATCH] [#2167] build libco when gtest is not enabled
Origin: backport, https://gitlab.isc.org/isc-projects/kea/-/commit/6b6620aabdd6c4997a6c5ccb0011a9d938409b3f
Bug: https://gitlab.isc.org/isc-projects/kea/-/issues/2167
Last-Update: 2022-01-12

diff --git a/src/bin/agent/tests/Makefile.am b/src/bin/agent/tests/Makefile.am
index 1bc1681..0a77ff8 100644
--- a/src/bin/agent/tests/Makefile.am
+++ b/src/bin/agent/tests/Makefile.am
@@ -15,7 +15,10 @@ TESTS = $(SHTESTS)
 
 # As with every file generated by ./configure, clean them up when running
 # "make distclean", but not on "make clean".
-DISTCLEANFILES = $(SHTESTS)
+DISTCLEANFILES  = $(SHTESTS)
+DISTCLEANFILES += test_basic_auth_libraries.h
+DISTCLEANFILES += test_callout_libraries.h
+DISTCLEANFILES += test_data_files_config.h
 
 # Don't install shell tests.
 noinst_SCRIPTS = $(SHTESTS)
@@ -105,12 +108,6 @@ nodist_ca_unittests_SOURCES += test_callout_libraries.h
 # Run C++ tests on "make check".
 TESTS += $(PROGRAM_TESTS)
 
-# As with every file generated by ./configure, clean them up when running
-# "make distclean", but not on "make clean".
-DISTCLEANFILES += test_basic_auth_libraries.h
-DISTCLEANFILES += test_callout_libraries.h
-DISTCLEANFILES += test_data_files_config.h
-
 # Don't install test libraries.
 noinst_LTLIBRARIES = libcallout.la libbasicauth.la
 
diff --git a/src/bin/dhcp4/tests/Makefile.am b/src/bin/dhcp4/tests/Makefile.am
index a4aedbc..cba5c96 100644
--- a/src/bin/dhcp4/tests/Makefile.am
+++ b/src/bin/dhcp4/tests/Makefile.am
@@ -15,16 +15,14 @@ TESTS = $(SHTESTS)
 
 # As with every file generated by ./configure, clean them up when running
 # "make distclean", but not on "make clean".
-DISTCLEANFILES = $(SHTESTS)
+DISTCLEANFILES  = $(SHTESTS)
+DISTCLEANFILES += marker_file.h
+DISTCLEANFILES += test_data_files_config.h
+DISTCLEANFILES += test_libraries.h
 
 # Don't install tests.
 noinst_SCRIPTS = $(SHTESTS)
 
-if HAVE_GTEST
-
-# C++ tests
-PROGRAM_TESTS = dhcp4_unittests
-
 AM_CPPFLAGS = -I$(top_srcdir)/src/lib -I$(top_builddir)/src/lib
 AM_CPPFLAGS += -I$(top_srcdir)/src -I$(top_builddir)/src
 AM_CPPFLAGS += -I$(top_srcdir)/src/bin -I$(top_builddir)/src/bin
@@ -72,6 +70,14 @@ libco3_la_CXXFLAGS = $(AM_CXXFLAGS)
 libco3_la_CPPFLAGS = $(AM_CPPFLAGS)
 libco3_la_LDFLAGS = -avoid-version -export-dynamic -module -rpath /nowhere
 
+# Don't install test libraries.
+noinst_LTLIBRARIES = libco1.la libco2.la libco3.la
+
+if HAVE_GTEST
+
+# C++ tests
+PROGRAM_TESTS = dhcp4_unittests
+
 dhcp4_unittests_SOURCES  = d2_unittest.h d2_unittest.cc
 dhcp4_unittests_SOURCES += dhcp4_unittests.cc
 dhcp4_unittests_SOURCES += dhcp4_srv_unittest.cc
@@ -163,15 +169,6 @@ dhcp4_unittests_LDADD += $(BOOST_LIBS) $(GTEST_LDADD)
 # Run C++ tests on "make check".
 TESTS += $(PROGRAM_TESTS)
 
-# As with every file generated by ./configure, clean them up when running
-# "make distclean", but not on "make clean".
-DISTCLEANFILES += marker_file.h
-DISTCLEANFILES += test_data_files_config.h
-DISTCLEANFILES += test_libraries.h
-
-# Don't install test libraries.
-noinst_LTLIBRARIES = libco1.la libco2.la libco3.la
-
 # Don't install C++ tests.
 noinst_PROGRAMS = $(PROGRAM_TESTS)
 
diff --git a/src/bin/dhcp6/tests/Makefile.am b/src/bin/dhcp6/tests/Makefile.am
index 9c39eda..bb07e73 100644
--- a/src/bin/dhcp6/tests/Makefile.am
+++ b/src/bin/dhcp6/tests/Makefile.am
@@ -15,16 +15,14 @@ TESTS = $(SHTESTS)
 
 # As with every file generated by ./configure, clean them up when running
 # "make distclean", but not on "make clean".
-DISTCLEANFILES = $(SHTESTS)
+DISTCLEANFILES  = $(SHTESTS)
+DISTCLEANFILES += marker_file.h
+DISTCLEANFILES += test_data_files_config.h
+DISTCLEANFILES += test_libraries.h
 
 # Don't install shell tests.
 noinst_SCRIPTS = $(SHTESTS)
 
-if HAVE_GTEST
-
-# C++ tests
-PROGRAM_TESTS = dhcp6_unittests
-
 AM_CPPFLAGS = -I$(top_srcdir)/src/lib -I$(top_builddir)/src/lib
 AM_CPPFLAGS += -I$(top_srcdir)/src/bin -I$(top_builddir)/src/bin
 AM_CPPFLAGS += -I$(top_srcdir)/src -I$(top_builddir)/src
@@ -73,6 +71,14 @@ libco3_la_CXXFLAGS = $(AM_CXXFLAGS)
 libco3_la_CPPFLAGS = $(AM_CPPFLAGS)
 libco3_la_LDFLAGS = -avoid-version -export-dynamic -module -rpath /nowhere
 
+# Don't install test libraries.
+noinst_LTLIBRARIES = libco1.la libco2.la libco3.la
+
+if HAVE_GTEST
+
+# C++ tests
+PROGRAM_TESTS = dhcp6_unittests
+
 # This list is ordered alphabetically. When adding new files, please maintain
 # this order.
 dhcp6_unittests_SOURCES  = classify_unittests.cc
@@ -163,15 +169,6 @@ dhcp6_unittests_LDADD += $(BOOST_LIBS) $(GTEST_LDADD)
 # Run C++ tests on "make check".
 TESTS += $(PROGRAM_TESTS)
 
-# As with every file generated by ./configure, clean them up when running
-# "make distclean", but not on "make clean".
-DISTCLEANFILES += marker_file.h
-DISTCLEANFILES += test_data_files_config.h
-DISTCLEANFILES += test_libraries.h
-
-# Don't install test libraries.
-noinst_LTLIBRARIES = libco1.la libco2.la libco3.la
-
 # Don't install C++ tests.
 noinst_PROGRAMS = $(PROGRAM_TESTS)
 
